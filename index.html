<!DOCTYPE html>
<html>
<head>
</head>
<body>

<pre>
	<code>
		<div class="column">
		</div>
	</code>
</pre>

<style>
.column {
	background-color: green;
	padding: 2px;
	border-radius: 5px
}
.token {
	border-radius: 5px;
	box-shadow: -1px 1px 2px black;
	padding: 4px;
	margin: 2px;
	border: 1px solid black;
	background-color: inherit;
}
.column *[data-indent="0"] {
	background-color: white;
}
.token[data-indent="none"] {
	border: unset !important;
	box-shadow: unset !important;
}
.column {
	--lineheight: 12px;
	width: min-content;
	display: block;
}
.column div{
	min-height: var(--lineheight);
}

</style>

<script>
const code = `
def add(x, y):
	return x + y

def add2(x, y):
	def add3(z):
		return z + 3
	return add3(add(x, y))

if __name__ == '__main__':
	print(add(1, 2))
`

const lines = code.split('\n')
const tokens = lines.map(line => ({
	text: line,
	indent: line.length - line.trimStart().length,
}))
let dom = ''
let token = 0
let peek = null

function parse() {
	const { text, indent } = tokens[token]
	peek = token + 1 < tokens.length
		? tokens[token + 1]
		: null

	if (indent == 0 && text.length == 0) {
		dom += '<div class="token" data-indent="none">'
		dom += '</div>'
	}
	else {
	
		dom += `<div class="token" data-indent="${indent}">`

		if (!peek || peek.indent == indent) {
			dom += text
		}
		else if (peek.indent > indent) {
			dom += text
			token += 1
			parse()
		}
		else if (peek.indent < indent) {
			dom += text // todo
			dom += '</div>'
		}

		dom += '</div>'
	}

	if (peek != null) {
		token += 1
		parse()
	}
}

parse()
document.querySelector('code .column').innerHTML = dom
</script>

</body>
</html>
